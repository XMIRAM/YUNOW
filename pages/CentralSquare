import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Link } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { Zap, User, Crown, Settings, Flame, Star, MapPin } from 'lucide-react';
import AvatarSprite from '@/components/world/AvatarSprite';
import FuelDisplay from '@/components/world/FuelDisplay';
import DistrictPortal from '@/components/world/DistrictPortal';
import EventPortal from '@/components/world/EventPortal';
import RoomCard from '@/components/world/RoomCard';
import SubscriptionModal from '@/components/subscription/SubscriptionModal';
import CosmeticsPanel from '@/components/cosmetics/CosmeticsPanel';

// Mock data for demo
const MOCK_TRENDING_ROOMS = [
  { id: '1', title: 'Is pineapple on pizza a crime?', type: 'arena', current_visitors: 47, fuel_boost: 12, district: 'meme' },
  { id: '2', title: 'Confessions of a night owl', type: 'confession', current_visitors: 23, district: 'cafe' },
  { id: '3', title: 'AI Art: Creative or Theft?', type: 'standard', current_visitors: 89, fuel_boost: 34, district: 'laboratory' },
];

const MOCK_COURT = {
  id: 'court-1',
  title: 'The Leftovers Incident',
  type: 'court',
  current_visitors: 156,
  court_story: "My roommate ate my clearly labeled leftovers...",
  court_verdict_guilty: 234,
  court_verdict_innocent: 189,
};

const MOCK_ARENA = {
  id: 'arena-1',
  title: 'Morning Shower vs Night Shower',
  type: 'arena',
  current_visitors: 312,
  arena_option_a: 'Morning shower wakes you up fresh',
  arena_option_b: 'Night shower = clean sleep',
  arena_votes_a: 1247,
  arena_votes_b: 1089,
};

export default function CentralSquare() {
  const [profile, setProfile] = useState(() => {
    const saved = localStorage.getItem('yunow_profile');
    return saved ? JSON.parse(saved) : null;
  });
  const [showSubscription, setShowSubscription] = useState(false);
  const [showCosmetics, setShowCosmetics] = useState(false);
  const [activeDistrict, setActiveDistrict] = useState('central');

  // Animation variants
  const containerVariants = {
    hidden: { opacity: 0 },
    show: {
      opacity: 1,
      transition: { staggerChildren: 0.1 }
    }
  };

  const itemVariants = {
    hidden: { opacity: 0, y: 20 },
    show: { opacity: 1, y: 0 }
  };

  return (
    <div className="min-h-screen bg-black text-white">
      {/* Top Bar */}
      <motion.div 
        className="sticky top-0 z-40 bg-black/90 backdrop-blur-lg border-b border-gray-800"
        initial={{ y: -50 }}
        animate={{ y: 0 }}
      >
        <div className="flex items-center justify-between p-4">
          {/* Profile */}
          <div className="flex items-center gap-3">
            <motion.div 
              whileTap={{ scale: 0.9 }}
              onClick={() => setShowCosmetics(true)}
              className="cursor-pointer"
            >
              <AvatarSprite 
                avatarId={profile?.avatar_id || 'avatar_1'} 
                size="md"
                frame={profile?.cosmetics?.frame || 'none'}
                showPresence
              />
            </motion.div>
            <div>
              <p className="text-white font-bold">{profile?.display_name || 'Guest'}</p>
              <p className="text-gray-500 text-xs flex items-center gap-1">
                <Star className="w-3 h-3 text-yellow-400" />
                <span>REP: {profile?.reputation || 0}</span>
              </p>
            </div>
          </div>

          {/* Fuel & Settings */}
          <div className="flex items-center gap-3">
            <FuelDisplay amount={profile?.fuel || 50} />
            <motion.button
              className="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center"
              whileTap={{ scale: 0.9 }}
              onClick={() => setShowSubscription(true)}
            >
              <Crown className="w-5 h-5 text-yellow-400" />
            </motion.button>
          </div>
        </div>
      </motion.div>

      {/* Main Content */}
      <motion.div 
        className="p-4 pb-20"
        variants={containerVariants}
        initial="hidden"
        animate="show"
      >
        {/* Location Header */}
        <motion.div 
          className="flex items-center gap-2 mb-6"
          variants={itemVariants}
        >
          <MapPin className="w-5 h-5 text-violet-400" />
          <h1 className="text-2xl font-black bg-gradient-to-r from-violet-400 to-purple-400 bg-clip-text text-transparent">
            Central Square
          </h1>
        </motion.div>

        {/* Event Portals */}
        <motion.div className="space-y-4 mb-8" variants={itemVariants}>
          <Link to={createPageUrl('Room') + '?id=trending'}>
            <EventPortal 
              type="trending" 
              subtitle="3 hot rooms right now"
              visitors={159}
            />
          </Link>
          
          <Link to={createPageUrl('Room') + `?id=${MOCK_COURT.id}`}>
            <EventPortal 
              type="court" 
              subtitle={MOCK_COURT.title}
              visitors={MOCK_COURT.current_visitors}
              timeLeft="18h left"
            />
          </Link>
          
          <Link to={createPageUrl('Room') + `?id=${MOCK_ARENA.id}`}>
            <EventPortal 
              type="arena" 
              subtitle={MOCK_ARENA.title}
              visitors={MOCK_ARENA.current_visitors}
            />
          </Link>
        </motion.div>

        {/* District Map */}
        <motion.div variants={itemVariants}>
          <h2 className="text-white font-bold text-lg mb-4 flex items-center gap-2">
            <span>üó∫Ô∏è</span> Explore Districts
          </h2>
          
          <div className="grid grid-cols-3 gap-3 mb-8">
            <Link to={createPageUrl('District') + '?area=cafe'}>
              <DistrictPortal district="cafe" visitors={67} size="sm" />
            </Link>
            <Link to={createPageUrl('District') + '?area=court'}>
              <DistrictPortal district="court" visitors={156} isActive size="sm" />
            </Link>
            <Link to={createPageUrl('District') + '?area=meme'}>
              <DistrictPortal district="meme" visitors={234} size="sm" />
            </Link>
            <Link to={createPageUrl('District') + '?area=laboratory'}>
              <DistrictPortal district="laboratory" visitors={45} size="sm" />
            </Link>
            <Link to={createPageUrl('District') + '?area=market'}>
              <DistrictPortal district="market" visitors={89} size="sm" />
            </Link>
          </div>
        </motion.div>

        {/* Trending Rooms */}
        <motion.div variants={itemVariants}>
          <h2 className="text-white font-bold text-lg mb-4 flex items-center gap-2">
            <Flame className="w-5 h-5 text-orange-400" />
            Hot Right Now
          </h2>
          
          <div className="space-y-3">
            {MOCK_TRENDING_ROOMS.map((room) => (
              <Link key={room.id} to={createPageUrl('Room') + `?id=${room.id}`}>
                <RoomCard room={room} />
              </Link>
            ))}
          </div>
        </motion.div>
      </motion.div>

      {/* Modals */}
      <SubscriptionModal 
        isOpen={showSubscription} 
        onClose={() => setShowSubscription(false)}
        currentPlan={profile?.subscription || 'free'}
      />
      
      <CosmeticsPanel
        isOpen={showCosmetics}
        onClose={() => setShowCosmetics(false)}
        avatarId={profile?.avatar_id}
        currentFrame={profile?.cosmetics?.frame}
        currentAura={profile?.cosmetics?.aura}
        onSave={(cosmetics) => {
          const updated = { ...profile, cosmetics };
          setProfile(updated);
          localStorage.setItem('yunow_profile', JSON.stringify(updated));
        }}
      />
    </div>
  );
}
